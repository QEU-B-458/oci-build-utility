FROM archlinux:latest

LABEL com.github.containers.toolbox="true" \
      usage="This image is meant to be used with the toolbox or distrobox command" \
      summary="A cloud-native terminal experience" \
      maintainer="jorge.castro@gmail.com"

RUN pacman-key --init

RUN pacman -Syyu --noconfirm base-devel git 

RUN useradd -m build_user && \
    passwd -d build_user && \
    printf 'docker_user ALL=(ALL) ALL\n' | tee -a /etc/sudoers

USER root

RUN mkdir /AUR && chown build_user:build_user /AUR

USER build_user

WORKDIR /AUR

RUN git clone https://aur.archlinux.org/paru.git

WORKDIR /AUR/paru

RUN makepkg -si --noconfirm

USER root

WORKDIR /



# Copy required files
COPY ../scripts/distrobox-shims.sh /distrobox-shims.sh
COPY ../packages/wivrnkit.packages /wivrnkit.packages

# --- ROOT: distrobox shims ---
RUN chmod +x /distrobox-shims.sh && /distrobox-shims.sh

# --- ROOT: system packages ---
RUN pacman -Syu --noconfirm --needed \
    base-devel \
    wget

# --- NON-ROOT: project deps via paru (repo + AUR) ---
USER 1000
RUN grep -v '^#' /wivrnkit.packages | \
    xargs paru -S --noconfirm --needed

# --- ROOT: AppImage tools ---
USER root
RUN wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage \
        -O /usr/local/bin/appimagetool && \
    chmod +x /usr/local/bin/appimagetool && \
    wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage \
        -O /usr/local/bin/linuxdeploy && \
    chmod +x /usr/local/bin/linuxdeploy

# --- Cleanup ---
RUN rm -f /distrobox-shims.sh /wivrnkit.packages

# --- Back to toolbox default user ---
USER 1000
